<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digo - Tarea 6: Cliente Web JWT - Fatima Gonz√°lez Romo</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="exercises.css">
    <link rel="stylesheet" href="codigo_tarea6.css">
    <script src="script.js"></script>
    <script src="codigo_tarea6.js"></script>
</head>
<body>
    <div class="container tarea6">
        <div class="header">
            <a href="tarea6.html" class="back-btn">‚Üê Volver a Tarea 6</a>
            <h1>Tarea 6: Books JWT + Redis</h1>
            <p>C√≥digo: Cliente Web (HTML, CSS, JS)</p>
        </div>
        
        <div class="content">
            <!-- C√≥digo -->
            <div class="code-section">
                <h3>C√≥digo del Cliente Web</h3>
            
                <!-- HTML Principal -->
                <button class="collapsible">1. HTML Principal (index.html)</button>
                <div class="collapsible-content">
                    <h4>Archivo: index.html</h4>
                    <div class="code-preview">
                    <div class="code-header-bar">
                        <div class="code-language">HTML</div>
                    </div>
                    <pre class="code-display"><code>&lt;!DOCTYPE html&gt;
&lt;html lang="es"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Books JWT Client&lt;/title&gt;
    &lt;link rel="stylesheet" href="styles.css"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;!-- Header --&gt;
        &lt;header class="header"&gt;
            &lt;h1&gt;üìö Books JWT Client&lt;/h1&gt;
            &lt;div class="auth-section"&gt;
                &lt;div id="login-form" class="auth-form"&gt;
                    &lt;h3&gt;Iniciar Sesi√≥n&lt;/h3&gt;
                    &lt;form id="loginForm"&gt;
                        &lt;input type="text" id="username" placeholder="Usuario" required&gt;
                        &lt;input type="password" id="password" placeholder="Contrase√±a" required&gt;
                        &lt;button type="submit"&gt;Login&lt;/button&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
                &lt;div id="user-info" class="user-info" style="display: none;"&gt;
                    &lt;span id="welcome-message"&gt;&lt;/span&gt;
                    &lt;button id="logout-btn"&gt;Logout&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/header&gt;

        &lt;!-- Main Content --&gt;
        &lt;main class="main-content"&gt;
            &lt;!-- Books Section --&gt;
            &lt;section id="books-section" class="books-section" style="display: none;"&gt;
                &lt;div class="section-header"&gt;
                    &lt;h2&gt;üìñ Lista de Libros&lt;/h2&gt;
                    &lt;button id="refresh-books" class="btn btn-primary"&gt;üîÑ Actualizar&lt;/button&gt;
                &lt;/div&gt;
                
                &lt;div id="books-list" class="books-list"&gt;&lt;/div&gt;
                
                &lt;!-- Add Book Form --&gt;
                &lt;div class="add-book-section"&gt;
                    &lt;h3&gt;‚ûï Agregar Nuevo Libro&lt;/h3&gt;
                    &lt;form id="add-book-form"&gt;
                        &lt;input type="text" id="book-title" placeholder="T√≠tulo" required&gt;
                        &lt;input type="text" id="book-author" placeholder="Autor" required&gt;
                        &lt;input type="number" id="book-year" placeholder="A√±o" required&gt;
                        &lt;button type="submit"&gt;Agregar Libro&lt;/button&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/section&gt;

            &lt;!-- Token Info Section --&gt;
            &lt;section id="token-info" class="token-info" style="display: none;"&gt;
                &lt;h3&gt;üîê Informaci√≥n de Tokens&lt;/h3&gt;
                &lt;div class="token-display"&gt;
                    &lt;div class="token-item"&gt;
                        &lt;label&gt;Access Token:&lt;/label&gt;
                        &lt;span id="access-token-display"&gt;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div class="token-item"&gt;
                        &lt;label&gt;Refresh Token:&lt;/label&gt;
                        &lt;span id="refresh-token-display"&gt;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div class="token-item"&gt;
                        &lt;label&gt;Token Status:&lt;/label&gt;
                        &lt;span id="token-status"&gt;&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/section&gt;
        &lt;/main&gt;

        &lt;!-- Logs Section --&gt;
        &lt;section id="logs-section" class="logs-section"&gt;
            &lt;h3&gt;üìù Logs del Cliente&lt;/h3&gt;
            &lt;div id="logs-container" class="logs-container"&gt;&lt;/div&gt;
        &lt;/section&gt;
    &lt;/div&gt;

    &lt;script src="app.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>
                </div>

                <!-- CSS Styles -->
                <button class="collapsible">2. Estilos CSS (styles.css)</button>
                <div class="collapsible-content">
                    <h4>Archivo: styles.css</h4>
                    <div class="code-preview">
                    <div class="code-header-bar">
                        <div class="code-language">CSS</div>
                    </div>
                    <pre class="code-display"><code>/* Estilos para el cliente JWT */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    color: #667eea;
    font-size: 2.5em;
    margin: 0;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.auth-form input {
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1em;
}

.auth-form button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.auth-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.books-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.books-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.book-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.book-card:hover {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.book-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.book-author {
    color: #666;
    margin-bottom: 8px;
}

.book-year {
    background: #667eea;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    display: inline-block;
}

.add-book-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #e9ecef;
}

.add-book-section h3 {
    margin-bottom: 15px;
    color: #333;
}

.add-book-section form {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.add-book-section input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
}

.add-book-section button {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.token-info {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.token-display {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.token-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.token-item label {
    font-weight: 600;
    min-width: 120px;
}

.token-item span {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.9em;
    word-break: break-all;
}

.logs-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.logs-container {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 20px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.9em;
    max-height: 300px;
    overflow-y: auto;
}

.log-entry {
    margin-bottom: 5px;
    padding: 5px 0;
    border-bottom: 1px solid #333;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-timestamp {
    color: #888;
}

.log-level {
    font-weight: bold;
}

.log-level.info {
    color: #4ec9b0;
}

.log-level.success {
    color: #4caf50;
}

.log-level.error {
    color: #f44336;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .section-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .add-book-section form {
        flex-direction: column;
    }
    
    .add-book-section input {
        min-width: 100%;
    }
}</code></pre>
                    </div>
                </div>

                <!-- JavaScript -->
                <button class="collapsible">3. JavaScript (app.js)</button>
                <div class="collapsible-content">
                    <h4>Archivo: app.js</h4>
                    <div class="code-preview">
                    <div class="code-header-bar">
                        <div class="code-language">JavaScript</div>
                    </div>
                    <pre class="code-display"><code>// Configuraci√≥n de la API
const API_BASE_URL = 'http://136.115.136.5:5003/api';

// Variables globales
let accessToken = null;
let refreshToken = null;
let refreshTimer = null;

// Elementos del DOM
const loginForm = document.getElementById('loginForm');
const logoutBtn = document.getElementById('logout-btn');
const booksSection = document.getElementById('books-section');
const tokenInfo = document.getElementById('token-info');
const booksList = document.getElementById('books-list');
const addBookForm = document.getElementById('add-book-form');
const refreshBooksBtn = document.getElementById('refresh-books');
const logsContainer = document.getElementById('logs-container');

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
    checkStoredTokens();
});

function initializeApp() {
    log('info', 'Aplicaci√≥n inicializada');
    updateUI();
}

function setupEventListeners() {
    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    addBookForm.addEventListener('submit', handleAddBook);
    refreshBooksBtn.addEventListener('click', loadBooks);
}

// Funciones de autenticaci√≥n
async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            accessToken = data.access_token;
            refreshToken = data.refresh_token;
            
            // Guardar tokens en localStorage
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);
            
            log('success', `Login exitoso para usuario: ${username}`);
            log('info', `Access Token: ${accessToken.substring(0, 20)}...`);
            log('info', `Refresh Token: ${refreshToken.substring(0, 20)}...`);
            
            updateUI();
            startTokenRefresh();
            loadBooks();
        } else {
            log('error', `Error en login: ${data.message}`);
        }
    } catch (error) {
        log('error', `Error de conexi√≥n: ${error.message}`);
    }
}

async function handleLogout() {
    try {
        if (accessToken) {
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
        }
        
        // Limpiar tokens
        accessToken = null;
        refreshToken = null;
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        
        // Limpiar timer
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        
        log('info', 'Logout exitoso');
        updateUI();
    } catch (error) {
        log('error', `Error en logout: ${error.message}`);
    }
}

// Funciones de tokens
function checkStoredTokens() {
    const storedAccessToken = localStorage.getItem('access_token');
    const storedRefreshToken = localStorage.getItem('refresh_token');
    
    if (storedAccessToken && storedRefreshToken) {
        accessToken = storedAccessToken;
        refreshToken = storedRefreshToken;
        updateUI();
        startTokenRefresh();
        loadBooks();
        log('info', 'Tokens recuperados del localStorage');
    }
}

async function refreshAccessToken() {
    try {
        const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${refreshToken}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            accessToken = data.access_token;
            localStorage.setItem('access_token', accessToken);
            log('success', 'Token refrescado exitosamente');
            updateTokenDisplay();
        } else {
            log('error', 'Error al refrescar token');
            handleLogout();
        }
    } catch (error) {
        log('error', `Error al refrescar token: ${error.message}`);
        handleLogout();
    }
}

function startTokenRefresh() {
    // Refrescar token cada 4 minutos (240 segundos)
    refreshTimer = setInterval(refreshAccessToken, 240000);
    log('info', 'Timer de refresh iniciado (cada 4 minutos)');
}

// Funciones de libros
async function loadBooks() {
    if (!accessToken) {
        log('error', 'No hay token de acceso');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/books`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (response.ok) {
            const books = await response.json();
            displayBooks(books);
            log('success', `${books.length} libros cargados`);
        } else {
            const error = await response.json();
            log('error', `Error al cargar libros: ${error.message}`);
        }
    } catch (error) {
        log('error', `Error de conexi√≥n: ${error.message}`);
    }
}

function displayBooks(books) {
    booksList.innerHTML = '';
    
    books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'book-card';
        bookCard.innerHTML = `
            <div class="book-title">${book.title}</div>
            <div class="book-author">Autor: ${book.author}</div>
            <div class="book-year">${book.published_year}</div>
        `;
        booksList.appendChild(bookCard);
    });
}

async function handleAddBook(e) {
    e.preventDefault();
    
    const title = document.getElementById('book-title').value;
    const author = document.getElementById('book-author').value;
    const year = document.getElementById('book-year').value;
    
    try {
        const response = await fetch(`${API_BASE_URL}/books`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                title,
                author,
                published_year: parseInt(year)
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            log('success', `Libro "${title}" agregado exitosamente`);
            addBookForm.reset();
            loadBooks(); // Recargar lista
        } else {
            log('error', `Error al agregar libro: ${data.message}`);
        }
    } catch (error) {
        log('error', `Error de conexi√≥n: ${error.message}`);
    }
}

// Funciones de UI
function updateUI() {
    const loginFormDiv = document.getElementById('login-form');
    const userInfoDiv = document.getElementById('user-info');
    const welcomeMessage = document.getElementById('welcome-message');
    
    if (accessToken) {
        loginFormDiv.style.display = 'none';
        userInfoDiv.style.display = 'flex';
        booksSection.style.display = 'block';
        tokenInfo.style.display = 'block';
        welcomeMessage.textContent = 'Usuario autenticado';
        updateTokenDisplay();
    } else {
        loginFormDiv.style.display = 'block';
        userInfoDiv.style.display = 'none';
        booksSection.style.display = 'none';
        tokenInfo.style.display = 'none';
    }
}

function updateTokenDisplay() {
    document.getElementById('access-token-display').textContent = 
        accessToken ? `${accessToken.substring(0, 30)}...` : 'No disponible';
    document.getElementById('refresh-token-display').textContent = 
        refreshToken ? `${refreshToken.substring(0, 30)}...` : 'No disponible';
    document.getElementById('token-status').textContent = 
        accessToken ? 'Activo' : 'Inactivo';
}

// Funciones de logging
function log(level, message) {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level ${level}">[${level.toUpperCase()}]</span>
        <span>${message}</span>
    `;
    
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
    
    // Mantener solo los √∫ltimos 50 logs
    const logs = logsContainer.querySelectorAll('.log-entry');
    if (logs.length > 50) {
        logs[0].remove();
    }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
